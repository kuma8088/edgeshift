name = "edgeshift-newsletter"
main = "src/index.ts"
compatibility_date = "2024-12-01"
workers_dev = false

# Production routes - need both exact and wildcard patterns
[[routes]]
pattern = "edgeshift.tech/api/newsletter/*"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/campaigns"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/campaigns/*"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/sequences"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/sequences/*"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/subscribers/*"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/dashboard/*"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/webhooks/*"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/analytics/*"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/admin/*"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/signup-pages"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/signup-pages/*"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/contact-lists"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/contact-lists/*"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/archive"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/archive/*"
zone_name = "edgeshift.tech"

[[routes]]
pattern = "edgeshift.tech/api/referral/*"
zone_name = "edgeshift.tech"

[vars]
ALLOWED_ORIGIN = "https://edgeshift.tech"
SENDER_EMAIL = "newsletter@mail.edgeshift.tech"
SENDER_NAME = "EdgeShift Newsletter"
SITE_URL = "https://edgeshift.tech"

# D1 Database binding
[[d1_databases]]
binding = "DB"
database_name = "edgeshift-newsletter"
database_id = "4ca2faf7-7486-4a66-b153-278acfa10d17"

# KV Namespace for rate limiting (Batch S)
# Purpose: Store rate limit state for /api/newsletter/subscribe endpoint
# Default limits: 5 requests per 10 minutes per email address
#
# SETUP INSTRUCTIONS:
# To create the KV namespace and get actual IDs, run:
#   1. Production: wrangler kv:namespace create RATE_LIMIT_KV --preview false
#   2. Preview:    wrangler kv:namespace create RATE_LIMIT_KV --preview
# Then replace the placeholder IDs below with the actual namespace IDs from the output.
#
# MANAGEMENT:
# - View keys:   wrangler kv:key list --namespace-id=<id>
# - Get value:   wrangler kv:key get <key> --namespace-id=<id>
# - Delete key:  wrangler kv:key delete <key> --namespace-id=<id>
# - Bulk delete: wrangler kv:bulk delete <key1> <key2> --namespace-id=<id>
#
# RATE LIMIT CONFIGURATION:
# The rate limit settings are defined in src/routes/subscribe.ts:
# - Window: 10 minutes (600 seconds)
# - Max attempts: 5 per IP address
# - Key format: "rate:subscribe:<ip>"
# To change limits, modify the constants in subscribe.ts
# Temporarily commented out until KV namespace is created
# [[kv_namespaces]]
# binding = "RATE_LIMIT_KV"
# id = "placeholder_for_prod"
# preview_id = "placeholder_for_preview"

# Cron trigger for scheduled campaigns (every 15 minutes)
[triggers]
crons = ["*/15 * * * *"]

# Secrets (set via `wrangler secret put <NAME>`):
# - RESEND_API_KEY
# - TURNSTILE_SECRET_KEY
# - ADMIN_API_KEY
# - RESEND_WEBHOOK_SECRET (for webhook signature verification)
