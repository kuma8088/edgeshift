# ユーザーテストで発生したエラー記録

**プロジェクト**: Newsletter Management System
**発生日**: 2025-12-23
**フェーズ**: Phase 2 ユーザーテスト
**環境**: 本番環境 (Cloudflare Workers + D1)

---

## 概要

Newsletter 管理画面のユーザーテスト中に、以下 5 件の重大なエラーが発生しました。すべてローカル環境では正常動作していたため、本番環境特有の設定・データベーススキーマの差異が原因でした。

---

## エラー詳細

### 1. API ルーティングエラー

#### 症状

`/api/campaigns` にアクセスすると HTML を返す（Cloudflare Pages のフォールバック応答）

```
GET /api/campaigns
Response: 200 OK
Content-Type: text/html
Body: <!DOCTYPE html>...
```

#### 原因

`wrangler.toml` の route pattern `/*` が末尾スラッシュなしのパスにマッチしない仕様。

```toml
# 問題のあった設定
[[routes]]
  pattern = "/*"
  zone_name = "edgeshift.dev"
```

Cloudflare Workers の route pattern は厳密なマッチングを行うため、`/api/campaigns` は `/*` にマッチしない。

#### 対処

exact path routes を追加して、末尾スラッシュの有無両方に対応：

```toml
[[routes]]
  pattern = "/api/campaigns"
  zone_name = "edgeshift.dev"

[[routes]]
  pattern = "/api/campaigns/*"
  zone_name = "edgeshift.dev"
```

すべての API エンドポイントに同様の設定を追加。

#### 教訓

- Cloudflare Workers の route pattern は厳密なマッチングを行う
- ローカル開発（`wrangler dev`）と本番環境でルーティング動作が異なる
- API エンドポイントは exact path と wildcard の両方を定義する

---

### 2. D1 テーブル不在エラー

#### 症状

```
D1_ERROR: no such table: delivery_logs at offset 25
```

API が D1 に存在しないテーブルを参照してエラー。

#### 原因

本番 D1 データベースに `schema.sql` が適用されていなかった。ローカル開発環境では `.wrangler/state/v3/d1/miniflare-D1DatabaseObject/` に自動的にテーブルが作成されていたが、本番環境には手動で migration が必要。

#### 対処

`wrangler d1 execute` でスキーマを適用：

```bash
wrangler d1 execute newsletter-d1 \
  --remote \
  --file=schema.sql
```

#### 教訓

- ローカル環境と本番環境でデータベース状態が異なる
- D1 は自動マイグレーション機能がない（明示的に `wrangler d1 execute` が必要）
- デプロイ前に本番 D1 のスキーマ状態を確認すべき
- CI/CD に schema validation を組み込む検討が必要

---

### 3. フロントエンド API レスポンス処理エラー

#### 症状

```
Uncaught (in promise) TypeError: c.map is not a function
  at CampaignList.tsx:23
```

複数のコンポーネント（CampaignList, SequenceList, SubscriberList）で同様のエラーが発生。

#### 原因

API のレスポンス構造とフロントエンドの期待が不一致。

**API が返すデータ**:
```json
{
  "data": {
    "campaigns": [...]
  }
}
```

**フロントエンドのコード**:
```typescript
const result = await response.json();
setCampaigns(result.data); // ❌ data は配列ではなくオブジェクト
```

#### 対処

フロントエンドコードを修正して正しいネストにアクセス：

```typescript
// Before
setCampaigns(result.data);

// After
setCampaigns(result.data.campaigns);
```

同様に SequenceList, SubscriberList も修正。

#### 教訓

- API レスポンス構造の型定義が不足していた
- TypeScript の型チェックが効いていなかった（`any` 型の使用）
- フロントエンドとバックエンドのコントラクトテストが必要
- `zod` などでレスポンススキーマをバリデーションすべき

---

### 4. キャンペーン作成 500 エラー

#### 症状

```
POST /api/campaigns
Response: 500 Internal Server Error

D1_ERROR: table campaigns has 7 columns but 10 values were supplied
```

#### 原因

INSERT 文が 10 カラムを期待するが、本番 D1 の `campaigns` テーブルには 7 カラムしかなかった。

**コード**:
```sql
INSERT INTO campaigns (
  id, name, subject, body, status,
  sender_name, sender_email,
  scheduled_at, timezone, send_at
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
```

**本番 D1 のスキーマ**:
```sql
CREATE TABLE campaigns (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  subject TEXT NOT NULL,
  body TEXT NOT NULL,
  status TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);
```

スケジュール関連カラム（`sender_name`, `sender_email`, `scheduled_at`, `timezone`, `send_at`）が未作成。

#### 対処

1. 本番 D1 に不足カラムを追加：

```bash
wrangler d1 execute newsletter-d1 --remote --command "
ALTER TABLE campaigns ADD COLUMN sender_name TEXT;
ALTER TABLE campaigns ADD COLUMN sender_email TEXT;
ALTER TABLE campaigns ADD COLUMN scheduled_at TEXT;
ALTER TABLE campaigns ADD COLUMN timezone TEXT DEFAULT 'Asia/Tokyo';
"
```

2. `schema.sql` を更新して同期
3. コードを修正してデプロイ

#### 教訓

- ローカル開発の `schema.sql` と本番 D1 が乖離していた
- スキーマのバージョン管理が不足
- マイグレーション戦略が未整備（ALTER TABLE を手動実行）
- **今後の対策**:
  - D1 Migrations の導入（`migrations/` ディレクトリで管理）
  - デプロイ前に `wrangler d1 migrations list --remote` で確認
  - スキーマの差分検出ツールの導入

---

### 5. サブエージェントのデプロイ漏れ

#### 症状

修正コードをコミット後も、同じ 500 エラーが続く。

#### 原因

サブエージェント（Claude Code の Plan Agent）がファイルを修正したが、`wrangler deploy` を実行していなかった。修正内容が本番環境に反映されていない状態。

#### 対処

手動で `wrangler deploy` を実行：

```bash
cd /Users/naoya/srv/workspace/dev/edgeshift/workers/newsletter
wrangler deploy
```

#### 教訓

- サブエージェントはデプロイまで完了させる責務がない
- **今後の対策**:
  - GitHub Actions で自動デプロイを設定（`main` ブランチへの push で trigger）
  - ローカルでの変更は必ず `wrangler deploy` を実行するチェックリスト化
  - デプロイ確認を TodoWrite に追加

---

## 全体的な教訓

### 環境差異の管理不足

- **問題**: ローカル環境と本番環境でデータベーススキーマ・ルーティング設定が異なる
- **対策**:
  - 環境同一性を担保する自動化スクリプト
  - デプロイ前の環境チェックリスト
  - スキーマバージョン管理（D1 Migrations）

### テスト戦略の不足

- **問題**: ローカル環境でのみテストしており、本番環境でのエンドツーエンドテストが未実施
- **対策**:
  - Staging 環境の構築（本番と同一構成）
  - API コントラクトテスト（Pact, OpenAPI）
  - 本番デプロイ前の smoke test 実施

### 型安全性の不足

- **問題**: API レスポンスの型定義が不足しており、`any` 型による実行時エラー
- **対策**:
  - `zod` でランタイムバリデーション
  - OpenAPI スキーマの自動生成
  - フロントエンドとバックエンドで共有する型定義ファイル

### デプロイプロセスの自動化不足

- **問題**: 手動デプロイによるヒューマンエラー
- **対策**:
  - GitHub Actions による CI/CD パイプライン
  - デプロイ前の自動テスト実行
  - Rollback 手順の整備

### ドキュメントの不足

- **問題**: デプロイ手順・環境構築手順が暗黙知
- **対策**:
  - `docs/deployment.md` にデプロイ手順を記載
  - `docs/troubleshooting.md` にエラー対処を蓄積
  - README に環境構築手順を明記

---

## 次のステップ

### 短期（Phase 2 完了まで）

- [ ] GitHub Actions で自動デプロイを設定
- [ ] `docs/deployment.md` 作成
- [ ] `docs/troubleshooting.md` 作成（本ドキュメントの内容を統合）

### 中期（Phase 3）

- [ ] D1 Migrations の導入
- [ ] Staging 環境の構築
- [ ] API コントラクトテストの導入
- [ ] `zod` によるランタイムバリデーション

### 長期

- [ ] モニタリング・アラート設定（Sentry, Cloudflare Analytics）
- [ ] エラートラッキングの自動化
- [ ] パフォーマンスモニタリング

---

## 関連ドキュメント

- `/Users/naoya/srv/workspace/dev/edgeshift/workers/newsletter/schema.sql`
- `/Users/naoya/srv/workspace/dev/edgeshift/workers/newsletter/wrangler.toml`
- `/Users/naoya/srv/workspace/dev/edgeshift/src/pages/admin/campaigns/CampaignList.tsx`
- `/Users/naoya/srv/workspace/documents/portfolio_site/newsletter_system/phase2_tasks.md`
