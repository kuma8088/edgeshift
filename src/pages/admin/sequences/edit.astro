---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { AuthProvider } from '../../../components/admin/AuthProvider';
---

<AdminLayout title="シーケンス編集">
  <AuthProvider client:load>
    <div class="space-y-6">
      <div>
        <a
          href="/admin/sequences"
          class="text-sm text-[var(--color-accent)] hover:underline"
        >
          ← シーケンス一覧に戻る
        </a>
        <h1 class="text-2xl font-bold text-[var(--color-text)] mt-2">シーケンス編集</h1>
      </div>

      <div class="bg-white rounded-lg p-6 shadow-sm border border-[var(--color-border)]">
        <div id="sequence-form-container">
          <div class="text-center py-8">
            <div class="animate-pulse text-[var(--color-text-secondary)]">読み込み中...</div>
          </div>
        </div>
      </div>
    </div>
  </AuthProvider>
</AdminLayout>

<script>
  import { getSequence, updateSequence } from '../../../utils/admin-api';
  import { SequenceForm } from '../../../components/admin/SequenceForm';
  import { createElement } from 'react';
  import { createRoot } from 'react-dom/client';

  const container = document.getElementById('sequence-form-container');
  if (container) {
    const root = createRoot(container);

    // Get sequence ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const sequenceId = urlParams.get('id');

    if (!sequenceId) {
      root.render(
        createElement('div', { className: 'text-center py-8 text-red-600' },
          'シーケンスIDが指定されていません'
        )
      );
    } else {
      // Load sequence data
      getSequence(sequenceId).then((result) => {
        if (result.success && result.data) {
          const data = result.data as { sequence: any };
          const sequence = data.sequence;

          const handleSubmit = async (data: any) => {
            // For update, we only send name, description, and is_active
            // Steps are updated separately if needed
            const updateData = {
              name: data.name,
              description: data.description,
            };

            const updateResult = await updateSequence(sequenceId, updateData);

            if (updateResult.success) {
              window.location.href = '/admin/sequences';
            } else {
              alert(updateResult.error || 'シーケンスの更新に失敗しました');
            }
          };

          const handleCancel = () => {
            window.location.href = '/admin/sequences';
          };

          root.render(
            createElement(SequenceForm, {
              sequence: sequence,
              onSubmit: handleSubmit,
              onCancel: handleCancel,
            })
          );
        } else {
          root.render(
            createElement('div', { className: 'text-center py-8 text-red-600' },
              result.error || 'シーケンスの読み込みに失敗しました'
            )
          );
        }
      });
    }
  }
</script>
