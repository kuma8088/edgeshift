---
paths:
  - "infrastructure/**/*"
  - "terraform/**/*"
  - "cdk/**/*"
  - "cloudformation/**/*"
---

# AWS インフラストラクチャ規約

---

## Well-Architected Framework の原則

```
1. 運用上の優秀性
   - IaC による自動化
   - モニタリングとアラート設定

2. セキュリティ
   - 最小権限の原則
   - 暗号化（保存時・転送時）
   - 監査ログの有効化

3. 信頼性
   - マルチAZ構成
   - 自動スケーリング
   - バックアップ戦略

4. パフォーマンス効率
   - 適切なインスタンスタイプ選択
   - キャッシュ戦略

5. コスト最適化
   - リソースの適正サイズ
   - 未使用リソースの削除
```

---

## IAM ポリシー

```json
// Good: 最小権限の原則
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::my-bucket/uploads/*"
    }
  ]
}

// Bad: 過剰な権限
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "s3:*",
      "Resource": "*"
    }
  ]
}
```

---

## VPC 設計

```
推奨構成:
┌─────────────────────────────────────────────────┐
│ VPC (10.0.0.0/16)                               │
│                                                 │
│  ┌─────────────────┐  ┌─────────────────┐      │
│  │ Public Subnet   │  │ Public Subnet   │      │
│  │ 10.0.1.0/24     │  │ 10.0.2.0/24     │      │
│  │ (AZ-a)          │  │ (AZ-c)          │      │
│  │ - ALB           │  │ - ALB           │      │
│  │ - NAT Gateway   │  │ - NAT Gateway   │      │
│  └─────────────────┘  └─────────────────┘      │
│                                                 │
│  ┌─────────────────┐  ┌─────────────────┐      │
│  │ Private Subnet  │  │ Private Subnet  │      │
│  │ 10.0.11.0/24    │  │ 10.0.12.0/24    │      │
│  │ (AZ-a)          │  │ (AZ-c)          │      │
│  │ - ECS/EC2       │  │ - ECS/EC2       │      │
│  └─────────────────┘  └─────────────────┘      │
│                                                 │
│  ┌─────────────────┐  ┌─────────────────┐      │
│  │ DB Subnet       │  │ DB Subnet       │      │
│  │ 10.0.21.0/24    │  │ 10.0.22.0/24    │      │
│  │ (AZ-a)          │  │ (AZ-c)          │      │
│  │ - RDS           │  │ - RDS           │      │
│  └─────────────────┘  └─────────────────┘      │
└─────────────────────────────────────────────────┘
```

---

## 機密情報管理

```
推奨:
- Secrets Manager: データベースパスワード、APIキー
- Parameter Store: 設定値、環境変数
- KMS: 暗号化キー管理

禁止:
- 環境変数に平文でシークレットを設定
- コード内にハードコード
- S3 に平文で保存
```

---

## モニタリング

```
CloudWatch 設定チェックリスト:
[ ] メトリクスアラーム（CPU, メモリ, ディスク）
[ ] ログ収集（アプリケーション、アクセス）
[ ] ダッシュボード作成
[ ] SNS 通知設定

推奨アラーム閾値:
- CPU 使用率: 80% 以上で警告
- メモリ使用率: 80% 以上で警告
- ディスク使用率: 70% 以上で警告
- エラー率: 1% 以上で警告
```

---

## コスト管理

```
必須タグ:
- Project: プロジェクト名
- Environment: dev / stg / prod
- Owner: 責任者メール
- CostCenter: コストセンター（該当する場合）

コスト削減のポイント:
- 開発環境は夜間・週末に停止
- Reserved Instances / Savings Plans の活用
- S3 ライフサイクルポリシーの設定
- 未使用 EIP, EBS の削除
```

---

## セキュリティ設定

```
必須設定:
[ ] CloudTrail 有効化（全リージョン）
[ ] GuardDuty 有効化
[ ] Config Rules 設定
[ ] S3 パブリックアクセスブロック
[ ] RDS の暗号化有効化
[ ] EBS の暗号化有効化（デフォルト）
[ ] VPC Flow Logs 有効化
```

---

## 禁止事項

```
絶対に行わないこと:
- root アカウントの日常使用
- IAM ユーザーへの直接ポリシーアタッチ（グループ/ロール経由で）
- セキュリティグループで 0.0.0.0/0 に SSH(22) を開放
- 本番環境で DeleteProtection を無効のまま運用
- マルチAZなしでの本番RDS運用
```
